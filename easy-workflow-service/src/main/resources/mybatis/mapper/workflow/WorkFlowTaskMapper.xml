<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yffd.easy.workflow.mapper.WorkFlowTaskMapper">
	
	<resultMap id="resutlId" type="com.yffd.easy.workflow.model.dto.WorkFlowTaskDTO">
		<id column="ID_" property="id" jdbcType="INTEGER" />
		<result column="EXECUTION_ID_" property="executionId" jdbcType="VARCHAR" />
		<result column="PROC_INST_ID_" property="instanceId" jdbcType="VARCHAR" />
		<result column="PROC_DEF_ID_" property="definitionId" jdbcType="VARCHAR" />
		<result column="NAME_" property="activityNodeName" jdbcType="VARCHAR" />
		<result column="TASK_DEF_KEY_" property="activityNodeId" jdbcType="VARCHAR" />
		<result column="ASSIGNEE_" property="assignee" jdbcType="VARCHAR" />
		<result column="CREATE_TIME_" property="createTime" jdbcType="TIMESTAMP" />
		<result column="SUSPENSION_STATE_" property="taskState" jdbcType="VARCHAR" />
		
		<result column="workFlowCategoryCode" property="workFlowCategoryCode" jdbcType="VARCHAR" />
		<result column="workFlowCategoryName" property="workFlowCategoryName" jdbcType="VARCHAR" />
		<result column="workFlowKey" property="workFlowKey" jdbcType="VARCHAR" />
		<result column="workFlowVersion" property="workFlowVersion" jdbcType="INTEGER" />
		<result column="workFlowDesc" property="workFlowDesc" jdbcType="VARCHAR" />
	</resultMap>
	
	<!-- 动态组装复合查询条件 -->
	<sql id="conditions_where">
		<!-- Equal query -->
		<if test="workFlowCategoryCode != null and workFlowCategoryCode != ''"> and def.CATEGORY_ = #{workFlowCategoryCode} </if>
		<if test="workFlowKey != null and workFlowKey != ''"> and def.KEY_ = #{workFlowKey} </if>
		<if test="activityNodeId != null and activityNodeId != ''"> and t1.TASK_DEF_KEY_ = #{activityNodeId} </if>
		<if test="assignee != null and assignee != ''"> and t1.ASSIGNEE_ = #{assignee} </if>
		<if test="taskState != null and taskState != ''"> and t1.SUSPENSION_STATE_ = #{taskState} </if>
		<if test="searchStartTime != null"><![CDATA[ and t1.CREATE_TIME_ >= #{searchStartTime} ]]></if>
		<if test="searchEndTime != null"><![CDATA[ and t1.CREATE_TIME_ <= #{searchEndTime} ]]></if>
		<!-- Like query -->
		<if test="activityNodeName != null and activityNodeName != ''"> and t1.NAME_ like CONCAT(CONCAT('%', #{activityNodeName}), '%') </if>
		<if test="workFlowCategoryName != null and workFlowCategoryName != ''"> and def.NAME_ like CONCAT(CONCAT('%', #{workFlowCategoryName}), '%') </if>
	</sql>
	<sql id="conditions_limit"><if test="pageParam != null"> limit #{pageParam.pageStartRow}, #{pageParam.pageLimit} </if></sql>
	
	<select id="selectListBy" parameterType="java.util.Map" resultMap="resutlId">
		SELECT t1.ID_, t1.EXECUTION_ID_, t1.PROC_INST_ID_, t1.PROC_DEF_ID_, t1.NAME_, t1.TASK_DEF_KEY_, t1.ASSIGNEE_, t1.CREATE_TIME_, t1.SUSPENSION_STATE_ 
		, def.CATEGORY_ workFlowCategoryCode, def.NAME_ workFlowCategoryName, def.KEY_ workFlowKey, def.VERSION_ workFlowVersion, def.DESCRIPTION_ workFlowDesc
		FROM act_ru_task t1
		LEFT JOIN act_re_procdef def ON t1.PROC_DEF_ID_ = def.ID_
		<where>
			<include refid="conditions_where" />
		</where>
		order by t1.CREATE_TIME_ desc
		<include refid="conditions_limit" />
	</select>
	
	<select id="selectCountBy" parameterType="java.util.Map" resultType="long">
		SELECT count(1)
		FROM act_ru_task t1
		LEFT JOIN act_re_procdef def ON t1.PROC_DEF_ID_ = def.ID_
		<where>
			<include refid="conditions_where" />
		</where>
	</select>
	
	<!-- 动态组装复合查询条件 -->
	<sql id="conditions_where_todo">
		<!-- Equal query -->
		<if test="workFlowCategoryCode != null and workFlowCategoryCode != ''"> and def.CATEGORY_ = #{workFlowCategoryCode} </if>
		<if test="workFlowKey != null and workFlowKey != ''"> and def.KEY_ = #{workFlowKey} </if>
		<if test="startTime != null"><![CDATA[ and t1.CREATE_TIME_ >= #{startTime} ]]></if>
		<if test="endTime != null"><![CDATA[ and t1.CREATE_TIME_ <= #{endTime} ]]></if>
		<!-- Like query -->
		<if test="workFlowCategoryName != null and workFlowCategoryName != ''"> and def.NAME_ like CONCAT(CONCAT('%', #{workFlowCategoryName}), '%') </if>
	</sql>
	
	<select id="selectTodoTaskListBy" parameterType="java.util.Map" resultMap="resutlId">
		SELECT *
		FROM
		(
			(
			SELECT t1.ID_, t1.EXECUTION_ID_, t1.PROC_INST_ID_, t1.PROC_DEF_ID_, t1.NAME_, t1.TASK_DEF_KEY_, t1.ASSIGNEE_, t1.CREATE_TIME_, t1.SUSPENSION_STATE_
			,def.CATEGORY_ workFlowCategoryCode, def.NAME_ workFlowCategoryName, def.KEY_ workFlowKey, def.VERSION_ workFlowVersion, def.DESCRIPTION_ workFlowDesc
			FROM act_ru_task t1
			LEFT JOIN act_re_procdef def ON t1.PROC_DEF_ID_ = def.ID_
			<where>
				t1.SUSPENSION_STATE_ = '1'
				<include refid="conditions_where_todo" />
				<if test="userIds != null">
					AND <foreach item="item" index="index" collection="userIds" open="(" separator="or" close=")">t1.ASSIGNEE_ = #{item}</foreach>
				</if>
			</where>
			)
			UNION
			(
			SELECT DISTINCT t1.ID_, t1.EXECUTION_ID_, t1.PROC_INST_ID_, t1.PROC_DEF_ID_, t1.NAME_, t1.TASK_DEF_KEY_, t1.ASSIGNEE_, t1.CREATE_TIME_, t1.SUSPENSION_STATE_
			,def.CATEGORY_ workFlowCategoryCode, def.NAME_ workFlowCategoryName, def.KEY_ workFlowKey, def.VERSION_ workFlowVersion, def.DESCRIPTION_ workFlowDesc
			FROM act_ru_task t1 
			LEFT JOIN act_ru_identitylink t2 ON t1.ID_ = t2.TASK_ID_
			LEFT JOIN act_re_procdef def ON t1.PROC_DEF_ID_ = def.ID_
			WHERE t1.SUSPENSION_STATE_ = '1' AND t2.TYPE_ = 'candidate'
			<include refid="conditions_where_todo" />
			<if test="userIds != null or roleIds != null">
			AND
			(
				<if test="userIds != null">
					<foreach item="item" index="index" collection="userIds" open="(" separator="or" close=")">t2.USER_ID_ = #{item}</foreach>
				</if>
				<if test="userIds != null and roleIds != null"> OR </if>
				<if test="roleIds != null">
					<foreach item="item" index="index" collection="roleIds" open="(" separator="or" close=")">t2.GROUP_ID_ = #{item}</foreach>
				</if>
			)
			</if>
			) 
		) n1
		ORDER BY CREATE_TIME_ desc
		<include refid="conditions_limit" />
	</select>
	
	<select id="selectTodoTaskCountBy" parameterType="java.util.Map" resultType="long">
		SELECT count(1)
		FROM
		(
			(
			SELECT t1.ID_ FROM act_ru_task t1
			LEFT JOIN act_re_procdef def ON t1.PROC_DEF_ID_ = def.ID_
			<where>
				t1.SUSPENSION_STATE_ = '1'
				<include refid="conditions_where" />
				<if test="userIds != null">
					AND <foreach item="item" index="index" collection="userIds" open="(" separator="or" close=")">t1.ASSIGNEE_ = #{item}</foreach>
				</if>
			</where>
			)
			UNION
			(
			SELECT DISTINCT t1.ID_ FROM act_ru_task t1 
			LEFT JOIN act_ru_identitylink t2 ON t1.ID_ = t2.TASK_ID_
			LEFT JOIN act_re_procdef def ON t1.PROC_DEF_ID_ = def.ID_
			WHERE t1.SUSPENSION_STATE_ = '1' AND t2.TYPE_ = 'candidate'
			<include refid="conditions_where" />
			<if test="userIds != null or roleIds != null">
			AND
			(
				<if test="userIds != null">
					<foreach item="item" index="index" collection="userIds" open="(" separator="or" close=")">t2.USER_ID_ = #{item}</foreach>
				</if>
				<if test="userIds != null and roleIds != null"> OR </if>
				<if test="roleIds != null">
					<foreach item="item" index="index" collection="roleIds" open="(" separator="or" close=")">t2.GROUP_ID_ = #{item}</foreach>
				</if>
			)
			</if>
			) 
		) n1
	</select>
	
</mapper>